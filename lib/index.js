"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _jsx=function(){var c="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103;return function(e,t,n,a){var o=e&&e.defaultProps,i=arguments.length-3;if(t||0===i||(t={}),t&&o)for(var s in o)void 0===t[s]&&(t[s]=o[s]);else t||(t=o||{});if(1===i)t.children=a;else if(1<i){for(var r=Array(i),l=0;l<i;l++)r[l]=arguments[l+3];t.children=r}return{$$typeof:c,type:e,key:void 0===n?null:""+n,ref:null,props:t,_owner:null}}}(),_slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],a=!0,o=!1,i=void 0;try{for(var s,r=e[Symbol.iterator]();!(a=(s=r.next()).done)&&(n.push(s.value),!t||n.length!==t);a=!0);}catch(e){o=!0,i=e}finally{try{!a&&r.return&&r.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react);require("./index.css");var _constant=require("./constant.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _ref=_jsx("i",{}),_ref2=_jsx("i",{}),PhotoViewer=function(e){function t(e){_classCallCheck(this,t);var y=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return y.getActiveIndex=function(e){var t=e.photos||[],n=y.props.photos||[],a=e.activeIndex||0;return!/^\d+$/.test(e.activeIndex)&&(0,_constant.compareArray)(t,n)&&(a=y.state.activeIndex),a>=t.length?0:a},y.bindEvent=function(e){var t="addEventListener";e&&(t="removeEventListener");var n=document;(n=y.imgViewer)[t]("mousewheel",y.handleMouseScroll,!1),n[t]("click",y.handleMouseUp,!1),n[t]("mousemove",y.handleMouseMove,!1),n[t]("mousedown",y.handleMouseDown,!1),n[t]("mouseleave",y.handleMouseLeave,!1),window[t]("resize",y.handleResize,!1)},y.handleMouseDown=function(e){e.preventDefault(),e.stopPropagation(),y.setState({isMouseDown:!0,mouseX:e.clientX,mouseY:e.clientY})},y.handleMouseMove=function(e){var t=0,n=0;if(y.state.isMouseDown){null!==y.state.mouseX&&null!==y.state.mouseY&&(t=e.clientX-y.state.mouseX,n=e.clientY-y.state.mouseY);var a=y.getImgWidthHeight(),o=_slicedToArray(a,2),i=o[0],s=o[1],r=1===Math.abs(y.state.rotate/90%2),l=Math.abs((y.state.scaleX-1)*y.state.width/2),c=Math.abs((y.state.scaleY-1)*y.state.height/2);r&&(l=Math.abs((i-y.state.scaleY*y.state.height)/2),c=Math.abs((y.state.scaleX*y.state.width-s)/2));var h=y.state.top+n,u=y.state.left+t;-c<h&&h<c||(h=h<0?-c:c),-l<u&&u<l||(u=u<0?-l:l),y.setState({mouseX:e.clientX,mouseY:e.clientY,top:h,left:u})}else y.setState({mouseX:e.clientX,mouseY:e.clientY})},y.handleMouseUp=function(e){y.setState({isMouseDown:!1,mouseX:e.clientX,mouseY:e.clientY})},y.handleMouseScroll=function(e){e.preventDefault();var t=0;if(e.wheelDelta?t=0<e.wheelDelta?1:-1:e.detail&&(t=0<e.detail?-1:1),0!==t){var n=e.clientX,a=e.clientY;if(y.imgViewer){var o=y.imgViewer.getBoundingClientRect();n-=o.left,a-=o.top}y.handleZoom(n,a,t,y.state.zoomSpeed)}},y.handleMouseLeave=function(){y.setState({mouseX:null,mouseY:null,isMouseDown:!1})},y.handleResize=function(e){var t=y.getImgWidthHeight(),n=_slicedToArray(t,2),a=n[0],o=n[1];y.setState({width:e&&e.cwidth||a,height:e&&e.cheight||o,left:0,top:0,rotate:0,scaleX:1,scaleY:1})},y.getImageCenterXY=function(){return{x:y.state.left+y.state.width/2,y:y.state.top+y.state.height/2}},y.handleZoom=function(e,t,n,a){var o=y.getImageCenterXY(),i=e-o.x,s=t-o.y,r=0,l=0,c=0,h=0,u=0,d=0;if(0===y.state.width){var p=y.getImgWidthHeight(),f=_slicedToArray(p,2),m=f[0],g=f[1];c=y.state.width+m,h=y.state.height+g,u=d=1}else{var v=0<y.state.scaleX?1:-1,_=0<y.state.scaleY?1:-1;if(u=y.state.scaleX+a*n*v,d=y.state.scaleY+a*n*_,Math.abs(u)<.1||Math.abs(d)<.1)return;r=y.state.top+-n*s/y.state.scaleX*a*v,l=y.state.left+-n*i/y.state.scaleY*a*_,c=y.state.width,h=y.state.height}y.setState({width:c,scaleX:u<.7?.7:u,scaleY:d<.7?.7:d,height:h,top:r,left:l,loading:!1})},y.handleRotate=function(e){y.setState({rotate:y.state.rotate+90*(e?1:-1)})},y.handleChangeImg=function(e,t){y.setState({activeIndex:e}),y.handleResize(t)},y.handleChangeImgIndex=function(e){y.handleChangeImg(e),y.props.onActiveChange&&y.props.onActiveChange(e)},y.doAction=function(e){if(y.props.photos&&0!==y.props.photos.length)switch(e){case _constant.ActionType.zoomIn:var t=y.getImageCenterXY();y.handleZoom(t.x,t.y,1,y.state.zoomSpeed);break;case _constant.ActionType.zoomOut:var n=y.getImageCenterXY();y.handleZoom(n.x,n.y,-1,y.state.zoomSpeed);break;case _constant.ActionType.rotateLeft:y.handleRotate();break;case _constant.ActionType.rotateRight:y.handleRotate(!0);break;case _constant.ActionType.prev:y.handleChangeImgIndex(y.state.activeIndex-1);break;case _constant.ActionType.next:y.handleChangeImgIndex(y.state.activeIndex+1);break;case _constant.ActionType.reset:y.handleResize()}},y.state={zoomSpeed:.05,width:0,left:0,top:0,height:0,rotate:0,scaleX:1,scaleY:1,activeIndex:0},y}return _inherits(t,_react.Component),_createClass(t,[{key:"componentWillReceiveProps",value:function(e){var t=this.getActiveIndex(e);this.handleChangeImg(t,e)}},{key:"componentDidMount",value:function(){this.bindEvent();var e=this.getImgWidthHeight(),t=_slicedToArray(e,2),n=t[0],a=t[1];this.setState({width:n,height:a,activeIndex:this.getActiveIndex(this.props)})}},{key:"componentWillUnmount",value:function(){this.bindEvent(!0)}},{key:"getImgWidthHeight",value:function(){return[this.imgViewer.getBoundingClientRect().width,this.imgViewer.getBoundingClientRect().height]}},{key:"render",value:function(){var n=this,e=this.props.photos||[],a=this.state.activeIndex,t={width:this.props.cwidth?this.props.cwidth+"px":"",height:this.props.cheight?this.props.cheight+"px":""},o={width:this.state.width?this.state.width+"px":"100%",height:this.state.height?this.state.height+"px":"100%",transform:"translateX("+(this.state.left?this.state.left+"px":"0px")+") translateY("+this.state.top+"px) rotate("+this.state.rotate+"deg) scaleX("+this.state.scaleX+") scaleY("+this.state.scaleY+")"};return _jsx("div",{className:"component-poi-fe-imgviewer",style:t},void 0,_react2.default.createElement("div",{className:"current-img",ref:function(e){n.imgViewer=e}},_jsx("ul",{className:"viewer-toolbar"},void 0,_constant.actionList&&_constant.actionList.map(function(e,t){return _jsx("li",{onClick:function(){return n.doAction(e.action)}},t,_jsx("i",{className:"viewer-icon viewer-icon-"+e.type}))})),0<a?_jsx("div",{onClick:function(){return n.doAction(3)},className:"pre-icon"},void 0,_ref):null,a<e.length-1?_jsx("div",{onClick:function(){return n.doAction(4)},className:"next-icon"},void 0,_ref2):null,e&&e.length?_jsx("img",{className:"big-img",src:e[a||0].url,style:o}):null),_jsx("div",{className:"bottom-content"},void 0,_jsx("div",{className:"bottom-imglist"},void 0,e&&e.map(function(e,t){return _jsx("img",{className:(a||0)===t?"bottom-imglist-current":"",src:e.url,onClick:function(){return n.handleChangeImgIndex(t)}},e.url)}))))}}]),t}();exports.default=PhotoViewer;